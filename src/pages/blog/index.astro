---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const posts = (await getCollection("blog"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

function fmtDate(d: Date) {
  return d.toISOString().slice(0, 10);
}

function uniqueTags(items: typeof posts) {
  const set = new Set<string>();
  for (const p of items) {
    for (const t of p.data.tags ?? []) set.add(String(t));
  }
  return Array.from(set).sort((a, b) => a.localeCompare(b));
}

const tags = uniqueTags(posts);
---

<BaseLayout title="Journal" description="Thoughts on engineering, philosophy, and life.">
  <div class="relative mx-auto min-h-screen max-w-6xl px-4 py-20 lg:grid lg:grid-cols-[1fr_260px] lg:gap-16 bg-neutral-50 dark:bg-neutral-950 transition-colors duration-300">
    
    <div class="hidden xl:block absolute left-0 top-24 text-[10px] font-mono tracking-[0.3em] [writing-mode:vertical-rl] font-bold text-neutral-900/10 dark:text-white/5 select-none pointer-events-none">
      システムエンジニアリング
    </div>

    <main>
      <header class="mb-16">
        <h1 class="text-4xl font-bold tracking-tight text-neutral-900 dark:text-white sm:text-5xl">Journal</h1>
        <p class="mt-6 text-lg leading-8 text-neutral-600 dark:text-neutral-400">
          A collection of thoughts on engineering, philosophy, and the systems we live in.
        </p>
      </header>

      <div class="space-y-8">
        {posts.map((post) => (
          <article class="group relative flex flex-col gap-4 rounded-2xl border p-8 transition-all duration-300 hover:-translate-y-1 border-neutral-200 bg-white shadow-sm hover:border-neutral-300 hover:shadow-xl dark:border-neutral-800 dark:bg-neutral-900/30 dark:shadow-none dark:hover:border-neutral-700 dark:hover:shadow-neutral-900/50">
            
            <div class="absolute inset-0 -z-10 rounded-2xl opacity-0 transition-opacity duration-500 group-hover:opacity-100 hidden dark:block" 
                 style="background-image: url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22noiseFilter%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.65%22 numOctaves=%223%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23noiseFilter)%22 opacity=%220.05%22/%3E%3C/svg%3E');">
            </div>

            <a href={`/blog/${post.slug}/`} class="absolute inset-0 z-0 rounded-2xl focus:outline-none focus:ring-2 focus:ring-neutral-400 dark:focus:ring-neutral-500"></a>

            <div class="relative z-10 flex flex-wrap items-center gap-x-4 gap-y-2 text-xs">
              <time class="flex items-center gap-1.5 font-mono text-neutral-500 transition-colors group-hover:text-neutral-700 dark:group-hover:text-neutral-400">
                <div class="h-1.5 w-1.5 rounded-full bg-neutral-200 dark:bg-neutral-800 transition-colors group-hover:bg-neutral-500"></div>
                {fmtDate(post.data.pubDate)}
              </time>
              
              {(post.data.tags?.length ?? 0) > 0 && (
                <div class="flex gap-2">
                  {post.data.tags.map((t) => (
                    <a 
                      href={`/tags/${encodeURIComponent(t)}/`}
                      class="relative rounded-md border px-2 py-1 font-mono text-[10px] uppercase tracking-wide transition-colors border-neutral-200 bg-neutral-100 text-neutral-500 hover:border-neutral-300 hover:text-neutral-700 dark:border-neutral-800 dark:bg-neutral-950/40 dark:text-neutral-500 dark:hover:border-neutral-600 dark:hover:text-neutral-300 dark:hover:bg-neutral-900"
                    >
                      {t}
                    </a>
                  ))}
                </div>
              )}
            </div>

            <div class="relative z-0 space-y-3">
              <h2 class="text-2xl font-bold leading-tight tracking-tight text-neutral-900 dark:text-neutral-100 transition-colors group-hover:text-neutral-600 dark:group-hover:text-white">
                {post.data.title}
              </h2>
              <p class="line-clamp-2 text-base leading-relaxed text-neutral-600 dark:text-neutral-400 transition-colors group-hover:text-neutral-700 dark:group-hover:text-neutral-300">
                {post.data.description}
              </p>
            </div>

            <div class="mt-2 flex items-center text-sm font-medium transition-colors duration-300 text-neutral-400 group-hover:text-neutral-900 dark:text-neutral-500 dark:group-hover:text-white">
              <span>Read article</span>
              
              <div class="ml-2 overflow-hidden">
                <svg 
                  xmlns="http://www.w3.org/2000/svg" 
                  viewBox="0 0 20 20" 
                  fill="currentColor" 
                  class="h-4 w-4 -translate-x-full opacity-0 transition-all duration-300 group-hover:translate-x-0 group-hover:opacity-100"
                >
                  <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
                </svg>
              </div>
            </div>

          </article>
        ))}
      </div>
    </main>

    <aside class="mt-20 lg:mt-0">
      <div class="sticky top-24 space-y-10">
        {tags.length > 0 && (
          <div class="space-y-4">
            <h3 class="flex items-center gap-2 font-mono text-xs font-semibold uppercase tracking-widest text-neutral-500">
              <span class="h-px w-4 bg-neutral-200 dark:bg-neutral-800"></span>
              Topics
            </h3>
            <div class="flex flex-wrap gap-2">
              {tags.map((t) => (
                <a 
                  href={`/tags/${encodeURIComponent(t)}/`}
                  class="rounded-full border px-3 py-1 text-xs transition-all border-neutral-200 text-neutral-500 hover:border-neutral-400 hover:text-neutral-900 dark:border-neutral-800 dark:text-neutral-400 dark:hover:border-neutral-600 dark:hover:text-neutral-200 dark:hover:bg-neutral-800/50"
                >
                  {t}
                </a>
              ))}
            </div>
          </div>
        )}
      </div>
    </aside>
  </div>
</BaseLayout>