---
import WeddingLayout from "../../layouts/WeddingLayout.astro";
import fs from "node:fs";
import path from "node:path";

import weddingPageScriptUrl from "../../scripts/weddings-page.ts?url";

export async function getStaticPaths() {
  const dataDir = path.join(process.cwd(), "public", "weddings", "data");
  const files = fs.readdirSync(dataDir);

  const slugs = files
    .filter((f) => f.endsWith(".json"))
    .map((f) => f.replace(/\.json$/, ""))
    .filter((s) => s !== "template");

  return slugs.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const detailsUrl = `/weddings/data/${slug}.json`;
const calendarUrl = `/weddings/calendars/${slug}.ics`;
const pageTitle = `Wedding Invitation - ${slug}`;
---

<WeddingLayout title={pageTitle} description="Wedding invitation details.">
  <noscript>
    <div class="mx-auto max-w-2xl px-4 py-10">
      <div class="rounded-2xl border p-6 dark:border-neutral-800">
        This page needs JavaScript enabled to show the invitation.
      </div>
    </div>
  </noscript>

  <!-- Lock Screen -->
  <div class="mx-auto max-w-md px-4 py-20" id="lockScreen">
    <div class="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm dark:border-neutral-800 dark:bg-neutral-900/30">
      <h1 class="text-2xl font-bold text-neutral-900 dark:text-white">Private Invitation</h1>
      <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400" id="lockHint">
        Enter the password to view details.
      </p>

      <input
        id="passwordInput"
        type="password"
        placeholder="Password"
        class="mt-4 w-full rounded-xl border px-4 py-2 text-sm dark:border-neutral-800 dark:bg-neutral-950"
      />

      <button
        id="unlockBtn"
        class="mt-4 w-full rounded-xl border px-4 py-2 text-sm font-semibold dark:border-neutral-800"
        type="button"
      >
        Unlock
      </button>

      <p id="errorMsg" class="mt-3 hidden text-sm text-red-600 dark:text-red-400">
        Incorrect password.
      </p>

      <p id="missingMsg" class="mt-3 hidden text-sm text-red-600 dark:text-red-400">
        Invitation data not found for this link.
      </p>
    </div>
  </div>

  <!-- Protected Content -->
  <div id="protectedContent" class="hidden">
    <div id="themeWrapper" class="relative min-h-screen overflow-hidden">
      
      <div id="decorCorners" class="pointer-events-none absolute inset-0 hidden z-0 dark:opacity-25 transition-opacity duration-300">
        <div id="decorTL" class="absolute left-0 top-0"></div>
        <div id="decorTR" class="absolute right-0 top-0"></div>
        <div id="decorBL" class="absolute left-0 bottom-0"></div>
        <div id="decorBR" class="absolute right-0 bottom-0"></div>
      </div>

      <div class="relative z-10 mx-auto max-w-3xl px-4 py-10">
        <div class="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm dark:border-neutral-800 dark:bg-neutral-900/90 backdrop-blur-sm">
          <div class="text-xs font-mono tracking-widest text-neutral-500 dark:text-neutral-400">
            WEDDING INVITATION
          </div>

          <div class="mt-3 flex flex-col gap-6 sm:flex-row sm:items-start sm:justify-between">
            <div class="min-w-0">
              <h1 id="coupleNames" class="text-4xl font-bold tracking-tight text-neutral-900 dark:text-white">
                Loadingâ€¦
              </h1>
              <p id="tagline" class="mt-3 text-neutral-600 dark:text-neutral-400"></p>
            </div>

            <div id="couplePhotoWrap" class="shrink-0 hidden">
              <img
                id="couplePhoto"
                alt=""
                class="h-28 w-28 object-cover ring-1 ring-neutral-200 dark:ring-neutral-800"
                loading="lazy"
                decoding="async"
              />
            </div>
          </div>

          <div class="mt-6 flex flex-wrap gap-3 text-sm">
            <div class="rounded-xl border px-3 py-2 dark:border-neutral-800">
              <span class="font-semibold">Date:</span>
              <span id="weddingDate"></span>
            </div>

            <div class="rounded-xl border px-3 py-2 dark:border-neutral-800">
              <span class="font-semibold">Countdown:</span>
              <span id="countdown"></span>
            </div>

            <div class="rounded-xl border px-3 py-2 dark:border-neutral-800">
              <span class="font-semibold">Updated:</span>
              <span id="lastUpdated"></span>
            </div>
          </div>

          <div class="mt-6 flex flex-wrap gap-3">
            <a id="mapBtn" class="rounded-xl border px-4 py-2 text-sm dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800" target="_blank" rel="noopener">
              Open Google Maps
            </a>

            <a id="subscribeBtn" class="rounded-xl border px-4 py-2 text-sm dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800">
              Subscribe for calendar updates
            </a>

            <a id="viewCalendarBtn" href={calendarUrl} class="rounded-xl border px-4 py-2 text-sm dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800" target="_blank" rel="noopener">
              View calendar feed
            </a>
          </div>

          <div class="mt-8 border-t pt-6 dark:border-neutral-800">
            <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">Schedule</h2>
            <div id="schedule" class="mt-4 grid gap-3"></div>
          </div>

          <div class="mt-8 border-t pt-6 dark:border-neutral-800">
            <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">Updates</h2>
            <div id="updates" class="mt-4 grid gap-3"></div>
          </div>

          <div class="mt-8 border-t pt-6 dark:border-neutral-800">
            <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">Contacts</h2>
            <div id="contacts" class="mt-4 grid gap-2 text-sm text-neutral-600 dark:text-neutral-400"></div>
          </div>

          <div class="mt-8 border-t pt-6 dark:border-neutral-800" id="rsvpSection" style="display:none;">
            <h2 class="text-lg font-semibold text-neutral-900 dark:text-white" id="rsvpTitle">RSVP</h2>
            <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400" id="rsvpDeadlineText" style="display:none;"></p>

            <div class="mt-4" id="rsvpButtonWrap" style="display:none;">
              <a id="rsvpButton" class="inline-block rounded-xl border px-4 py-2 text-sm font-semibold dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800">
                RSVP Now
              </a>
              <div class="mt-2 text-xs text-neutral-600 dark:text-neutral-400">
                <a id="rsvpOpenInNewTab" target="_blank" rel="noopener" class="underline">Open in Google Forms</a>
              </div>
            </div>

            <div class="mt-4" id="rsvpEmbedWrap" style="display:none;">
              <iframe
                id="rsvpIframe"
                title="RSVP Form"
                class="w-full rounded-2xl border dark:border-neutral-800"
                style="height: 900px;"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
              ></iframe>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- 1) pass config to window -->
  <script is:inline define:vars={{ detailsUrl, calendarUrl, slug }}>
    window.__WEDDING_PAGE__ = { detailsUrl, calendarUrl, slug };
  </script>

  <!-- 2) load bundled entry from /src -->
  <script type="module" src="/src/scripts/weddings-page.ts"></script>
  <script
    id="weddingPageScript"
    type="module"
    src={weddingPageScriptUrl}
    data-details-url={detailsUrl}
    data-calendar-url={calendarUrl}
    data-slug={slug}
  />

</WeddingLayout>
