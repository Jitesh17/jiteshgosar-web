---
import WeddingLayout from "../../layouts/WeddingLayout.astro";
import fs from "node:fs";
import path from "node:path";

export async function getStaticPaths() {
  try {
    const dataDir = path.join(process.cwd(), "public", "weddings", "data");

    // 1. Safety Check: Ensure directory exists prevents build crash
    if (!fs.existsSync(dataDir)) {
      console.warn(`[getStaticPaths] Warning: Data directory not found at ${dataDir}`);
      return []; 
    }

    const files = fs.readdirSync(dataDir);

    const slugs = files
      .filter((f) => f.endsWith(".json"))
      .map((f) => f.replace(/\.json$/, ""))
      .filter((s) => s !== "template");

    return slugs.map((slug) => ({ params: { slug } }));

  } catch (error) {
    // 2. Catch permissions or other FS errors so build finishes
    console.error("[getStaticPaths] Error generating paths:", error);
    return [];
  }
}

const { slug } = Astro.params;

// Critical for GitHub Pages subpath deploys
const baseUrl = import.meta.env.BASE_URL;

// URL Construction
const detailsUrl = `${baseUrl}weddings/data/${slug}.json`;
const calendarUrl = `${baseUrl}weddings/calendars/${slug}.ics`;
const pageTitle = `Wedding Invitation - ${slug}`;
---

<WeddingLayout title={pageTitle} description="Wedding invitation details.">
  <noscript>
    <div class="mx-auto max-w-2xl px-4 py-10">
      <div class="rounded-2xl border p-6 dark:border-neutral-800">
        This page needs JavaScript enabled to show the invitation.
      </div>
    </div>
  </noscript>

  <!-- Lock Screen -->
  <div class="mx-auto max-w-md px-4 py-20" id="lockScreen"><div class="card-joy relative z-10 mx-auto max-w-3xl shadow-2xl">
      <h1 class="text-2xl font-bold text-neutral-900 dark:text-white">Private Invitation</h1>
      <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400" id="lockHint">
        Enter the password to view details.
      </p>

      <input
        id="passwordInput"
        type="password"
        placeholder="Password"
        autocomplete="off"
        class="mt-4 w-full rounded-xl border px-4 py-2 text-sm dark:border-neutral-800 dark:bg-neutral-950"
      />

      <button
        id="unlockBtn"
        class="mt-4 w-full rounded-xl border px-4 py-2 text-sm font-semibold dark:border-neutral-800"
        type="button"
      >
        Unlock
      </button>

      <p id="errorMsg" class="mt-3 hidden text-sm text-red-600 dark:text-red-400">
        Incorrect password.
      </p>

      <p id="missingMsg" class="mt-3 hidden text-sm text-red-600 dark:text-red-400">
        Invitation data not found for this link.
      </p>
    </div>
  </div>

  <!-- Protected Content -->
  <div id="protectedContent" class="hidden">
    <div id="themeWrapper" class="relative min-h-screen overflow-hidden">
      <!-- Decor corners -->
      <div id="decorCorners" class="pointer-events-none absolute inset-0 hidden z-0">
        <div id="decorTL" class="absolute left-0 top-0"></div>
        <div id="decorTR" class="absolute right-0 top-0"></div>
        <div id="decorBL" class="absolute left-0 bottom-0"></div>
        <div id="decorBR" class="absolute right-0 bottom-0"></div>
      </div>

      <div class="card-joy relative z-10 mx-auto max-w-3xl shadow-2xl">
        <div class="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm dark:border-neutral-800 dark:bg-neutral-900/90 backdrop-blur-sm">
          <div class="text-center space-y-4 mt-6">
            <h1 id="coupleNames" class="font-heading text-6xl sm:text-7xl font-medium tracking-wide text-neutral-900 dark:text-white leading-tight">
              Loading...
            </h1>
            <p id="tagline" class="font-heading text-xl italic text-neutral-600 dark:text-neutral-400"></p>
            
            <div class="py-4">
              <div id="weddingDate" class="font-heading text-3xl text-neutral-800 dark:text-neutral-200"></div>
              <div id="cityLine" class="font-body text-sm uppercase tracking-widest text-neutral-500 mt-2"></div>
            </div>
          </div>

          <div id="countdown" class="flex justify-center my-8"></div>

          <div class="flex flex-col items-center gap-4 mb-12">
            
            <a id="mapBtn" class="px-8 py-3 rounded-full bg-neutral-900 text-white font-medium text-sm hover:bg-neutral-800 transition-all hover:scale-105 dark:bg-white dark:text-black cursor-pointer shadow-lg shadow-neutral-500/20" target="_blank" rel="noopener">
              Open Location Map
            </a>

            <div class="flex flex-row gap-3">
              <a id="subscribeBtn" class="px-5 py-2 rounded-full border border-neutral-300 text-neutral-600 font-medium text-xs hover:border-black hover:text-black transition-colors dark:border-neutral-700 dark:text-neutral-400 dark:hover:text-white cursor-pointer">
                ‚Üª Sync Calendar
              </a>
              
              <a id="viewCalendarBtn" class="px-5 py-2 rounded-full border border-neutral-300 text-neutral-600 font-medium text-xs hover:border-black hover:text-black transition-colors dark:border-neutral-700 dark:text-neutral-400 dark:hover:text-white cursor-pointer" target="_blank" rel="noopener">
                ‚Üì Save to Calendar
              </a>
            </div>

          </div>   
          
          <div class="mt-8 border-t pt-6 dark:border-neutral-800">
            <h2 class="font-heading text-3xl text-neutral-900 dark:text-white mb-6 border-b border-neutral-200 dark:border-neutral-800 pb-2">Schedule</h2>
            <div id="schedule" class="mt-4 grid gap-3"></div>
          </div>

          <!-- <div class="mt-8 border-t pt-6 dark:border-neutral-800">
            <h2 class="font-heading text-3xl text-neutral-900 dark:text-white mb-6 border-b border-neutral-200 dark:border-neutral-800 pb-2">Updates</h2>
            <div id="updates" class="mt-4 grid gap-3"></div>
          </div> -->

          <div class="mt-8 border-t pt-6 dark:border-neutral-800">
            <h2 class="font-heading text-3xl text-neutral-900 dark:text-white mb-6 border-b border-neutral-200 dark:border-neutral-800 pb-2">Contacts</h2>
            <div id="contacts" class="mt-4 grid gap-2 text-sm text-neutral-600 dark:text-neutral-400"></div>
          </div>

          <div class="mt-8 border-t pt-6 dark:border-neutral-800" id="rsvpSection" style="display:none;">
            <h2 class="text-lg font-semibold text-neutral-900 dark:text-white" id="rsvpTitle">RSVP</h2>
            <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400" id="rsvpDeadlineText" style="display:none;"></p>

            <div class="mt-4" id="rsvpButtonWrap" style="display:none;">
              <a id="rsvpButton" class="inline-block rounded-xl border px-4 py-2 text-sm font-semibold dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800">
                RSVP
              </a>
              <div class="mt-2 text-xs text-neutral-600 dark:text-neutral-400">
                <a id="rsvpOpenInNewTab" target="_blank" rel="noopener" class="underline">Open in Google Forms</a>
              </div>
            </div>

            <div class="mt-4" id="rsvpEmbedWrap" style="display:none;">
              <iframe
                id="rsvpIframe"
                title="RSVP Form"
                class="w-full rounded-2xl border dark:border-neutral-800"
                style="height: 900px;"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
              ></iframe>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script is:inline define:vars={{ detailsUrl, calendarUrl, slug, baseUrl }}>
    const $ = (id) => document.getElementById(id);

    function pad2(n) {
      return String(n).padStart(2, "0");
    }

    function isAbsUrl(u) {
      return typeof u === "string" && /^(https?:|data:)/i.test(u);
    }

    // Makes "/weddings/..." work on GitHub Pages base paths like "/repo/"
    function resolveAssetUrl(u) {
      if (!u) return "";
      if (isAbsUrl(u)) return u;

      const baseNoSlash = String(baseUrl || "/").replace(/\/$/, "");

      // If JSON uses "/weddings/..", prefix base
      if (u.startsWith("/")) return baseNoSlash + u;

      // If JSON uses "weddings/..", also prefix base
      return String(baseUrl || "/") + u;
    }

    function formatLocal(iso) {
      const d = new Date(iso);
      const opts = { weekday: "short", year: "numeric", month: "short", day: "2-digit", hour: "2-digit", minute: "2-digit" };
      return d.toLocaleString(undefined, opts);
    }

    function renderCountdown(el, targetIso, label) {
      if (!el) return null;

      // 1. SETUP: Create the fancy block structure
      if (!el.querySelector('.countdown-unit')) {
        // UPDATED: Added "w-full" and "justify-center" to force centering
        el.className = "flex flex-wrap gap-6 sm:gap-10 justify-center w-full my-6"; 
        el.innerHTML = `
          <div class="countdown-unit text-center min-w-[60px]">
            <div class="font-heading text-4xl sm:text-5xl text-neutral-900 dark:text-white leading-none" data-type="d">0</div>
            <div class="text-[10px] uppercase tracking-widest text-neutral-500 mt-2 font-medium">Days</div>
          </div>
          <div class="countdown-unit text-center min-w-[60px]">
            <div class="font-heading text-4xl sm:text-5xl text-neutral-900 dark:text-white leading-none" data-type="h">00</div>
            <div class="text-[10px] uppercase tracking-widest text-neutral-500 mt-2 font-medium">Hrs</div>
          </div>
          <div class="countdown-unit text-center min-w-[60px]">
            <div class="font-heading text-4xl sm:text-5xl text-neutral-900 dark:text-white leading-none" data-type="m">00</div>
            <div class="text-[10px] uppercase tracking-widest text-neutral-500 mt-2 font-medium">Mins</div>
          </div>
          <div class="countdown-unit text-center min-w-[60px]">
            <div class="font-heading text-4xl sm:text-5xl text-neutral-900 dark:text-white leading-none" data-type="s">00</div>
            <div class="text-[10px] uppercase tracking-widest text-neutral-500 mt-2 font-medium">Secs</div>
          </div>
        `;
      }

      const dEl = el.querySelector('[data-type="d"]');
      const hEl = el.querySelector('[data-type="h"]');
      const mEl = el.querySelector('[data-type="m"]');
      const sEl = el.querySelector('[data-type="s"]');
      const pad = (n) => String(n).padStart(2, "0");

      function tick() {
        const ms = new Date(targetIso).getTime() - Date.now();
        
        if (ms <= 0) {
          el.innerHTML = `<div class="font-heading text-3xl text-neutral-900 dark:text-white animate-pulse">Happening now</div>`;
          return false;
        }

        const s = Math.floor(ms / 1000);
        const days = Math.floor(s / 86400);
        const hours = Math.floor((s % 86400) / 3600);
        const mins = Math.floor((s % 3600) / 60);
        const secs = s % 60;

        if (dEl) dEl.textContent = days;
        if (hEl) hEl.textContent = pad(hours);
        if (mEl) mEl.textContent = pad(mins);
        if (sEl) sEl.textContent = pad(secs);
        
        return true;
      }

      if (tick()) {
        return setInterval(() => { tick(); }, 1000);
      }
      return null;
    }

    function buildGoogleCalendarLink(ev) {
      const start = new Date(ev?.start);
      const end = new Date(ev?.end);

      if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) {
        return "https://calendar.google.com/calendar/";
      }

      const fmt = (d) => {
        const y = d.getUTCFullYear();
        const mo = pad2(d.getUTCMonth() + 1);
        const da = pad2(d.getUTCDate());
        const h = pad2(d.getUTCHours());
        const mi = pad2(d.getUTCMinutes());
        const ss = pad2(d.getUTCSeconds());
        return `${y}${mo}${da}T${h}${mi}${ss}Z`;
      };

      const dates = `${fmt(start)}/${fmt(end)}`;
      const title = encodeURIComponent(String(ev?.title || "Event"));
      const details = encodeURIComponent(String(ev?.notes || ""));
      const location = encodeURIComponent([ev?.locationName, ev?.address].filter(Boolean).join(", "));

      return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dates}&details=${details}&location=${location}`;
    }

    function applyTheme(theme) {
      const wrapper = $("themeWrapper");
      if (!wrapper) return;

      // Reset styles we control
      wrapper.style.backgroundImage = "";
      wrapper.style.backgroundSize = "";
      wrapper.style.backgroundPosition = "";
      wrapper.style.backgroundRepeat = "";

      // Remove any old gradient classes (best effort)
      wrapper.classList.remove("bg-gradient-to-br");
      [...wrapper.classList].forEach((c) => {
        if (c.startsWith("from-") || c.startsWith("via-") || c.startsWith("to-")) wrapper.classList.remove(c);
      });

      if (!theme) return;

      if (theme.background === "gradient" && theme.gradient) {
        wrapper.classList.add("bg-gradient-to-br");
        String(theme.gradient).split(" ").forEach((c) => wrapper.classList.add(c));
        return;
      }

      if (theme.background === "image" && theme.imageUrl) {
        wrapper.style.backgroundImage = `url('${resolveAssetUrl(theme.imageUrl)}')`;
        wrapper.style.backgroundSize = "cover";
        wrapper.style.backgroundPosition = "center";
        wrapper.style.backgroundRepeat = "no-repeat";
      }
    }

    // Supports details.decor OR details.theme.decor
    function applyDecor(details) {
      const root = $("decorCorners");
      const tl = $("decorTL");
      const tr = $("decorTR");
      const bl = $("decorBL");
      const br = $("decorBR");
      if (!root || !tl || !tr || !bl || !br) return;

      // Reset
      root.classList.add("hidden");
      for (const el of [tl, tr, bl, br]) {
        el.style.backgroundImage = "";
        el.style.backgroundRepeat = "no-repeat";
        el.style.backgroundSize = "";
        el.style.backgroundPosition = "";
        el.style.width = "";
        el.style.height = "";
        el.style.opacity = "";
        el.style.transform = "";
        el.style.filter = "";
      }

      const d = details?.decor || details?.theme?.decor;
      if (!d || d.enabled !== true) return;

      const isDark = document.documentElement.classList.contains("dark");
      const opacity = isDark ? (d.opacityDark ?? 0.16) : (d.opacityLight ?? 0.28);
      const size = Number(d.size || 360);

      // Starting rotation (your request)
      const baseRot = Number(d.rotation || 0);
      const autoRotate = d.rotate !== false;

      const pick = (key) => d.corners?.[key]?.imageUrl || d.imageUrl || "";
      const extra = (key) => Number(d.corners?.[key]?.rotation || 0);

      const setCorner = (el, url, rotDeg) => {
        if (!url) return;
        el.style.width = `${size}px`;
        el.style.height = `${size}px`;
        el.style.opacity = String(opacity);
        el.style.backgroundImage = `url('${resolveAssetUrl(url)}')`;
        el.style.backgroundRepeat = "no-repeat";
        el.style.backgroundSize = "contain";
        el.style.backgroundPosition = "center";
        el.style.transform = `rotate(${rotDeg}deg)`;
      };

      // Corner offsets if autoRotate enabled
      const offTL = 0;
      const offTR = autoRotate ? 90 : 0;
      const offBL = autoRotate ? -90 : 0;
      const offBR = autoRotate ? 180 : 0;

      setCorner(tl, pick("tl"), baseRot + offTL + extra("tl"));
      setCorner(tr, pick("tr"), baseRot + offTR + extra("tr"));
      setCorner(bl, pick("bl"), baseRot + offBL + extra("bl"));
      setCorner(br, pick("br"), baseRot + offBR + extra("br"));

      // Show only if at least one image exists
      if (pick("tl") || pick("tr") || pick("bl") || pick("br")) root.classList.remove("hidden");
    }

    function renderCouplePhoto(details) {
      const wrap = $("couplePhotoWrap");
      const img = $("couplePhoto");
      if (!wrap || !img) return;

      // Default: completely hidden, no placeholder
      wrap.classList.add("hidden");
      img.removeAttribute("src");
      img.alt = "";
      img.style.width = "";
      img.style.height = "";
      img.classList.remove("rounded-full", "rounded-2xl");

      const photo = details?.media?.couplePhoto;
      if (!photo || photo.enabled !== true || !photo.src) return;

      const size = Number(photo.size || 140);
      img.src = resolveAssetUrl(photo.src);
      img.alt = photo.alt || "";
      img.style.width = `${size}px`;
      img.style.height = `${size}px`;

      const shape = String(photo.shape || "circle").toLowerCase();
      img.classList.add(shape === "rounded" ? "rounded-2xl" : "rounded-full");

      wrap.classList.remove("hidden");
    }

    function renderRsvp(rsvp) {
      const section = $("rsvpSection");
      const title = $("rsvpTitle");
      const deadlineText = $("rsvpDeadlineText");

      const buttonWrap = $("rsvpButtonWrap");
      const button = $("rsvpButton");
      const openNewTab = $("rsvpOpenInNewTab");

      const embedWrap = $("rsvpEmbedWrap");
      const iframe = $("rsvpIframe");

      if (!section || !title || !deadlineText || !buttonWrap || !button || !openNewTab || !embedWrap || !iframe) return;

      section.style.display = "none";
      buttonWrap.style.display = "none";
      embedWrap.style.display = "none";
      deadlineText.style.display = "none";
      iframe.removeAttribute("src");

      if (!rsvp || rsvp.enabled !== true) return;

      section.style.display = "block";
      title.textContent = rsvp.title || "RSVP";

      if (rsvp.deadline) {
        deadlineText.textContent = `RSVP deadline: ${formatLocal(rsvp.deadline)}`;
        deadlineText.style.display = "block";
      }

      const mode = String(rsvp.mode || "button").toLowerCase();
      const showButton = rsvp.showButton !== false;

      if (rsvp.formUrl) {
        openNewTab.href = rsvp.formUrl;
        openNewTab.textContent = rsvp.openInNewTabText || "Open in Google Forms";
      }

      // Button mode
      if (mode === "button") {
        if (!rsvp.formUrl) return;
        button.textContent = rsvp.buttonText || "RSVP Now";
        button.href = rsvp.formUrl;
        button.target = "_blank";
        button.rel = "noopener";
        buttonWrap.style.display = "block";
        return;
      }

      // Embed mode
      if (!rsvp.embedUrl) return;

      let iframeLoaded = false;

      // If no button, load immediately
      if (!showButton) {
        iframe.src = rsvp.embedUrl;
        embedWrap.style.display = "block";
        return;
      }

      // Show button first, then embed on click
      buttonWrap.style.display = "block";
      button.textContent = rsvp.buttonText || "Open RSVP here";
      button.href = "#";
      button.target = "";
      button.rel = "";

      button.onclick = (e) => {
        e.preventDefault();
        embedWrap.style.display = "block";
        if (!iframeLoaded) {
          iframe.src = rsvp.embedUrl;
          iframeLoaded = true;
        }
        embedWrap.scrollIntoView({ behavior: "smooth", block: "start" });
      };
    }

function renderInvite(details) {
      try {
        // --- 1. Basic Text Details ---
        $("coupleNames").textContent = details.coupleNames || "";
        $("tagline").textContent = details.tagline || "";
        $("cityLine").textContent = details.cityLine || "";

        const startIso = details?.primaryEvent?.start;
        $("weddingDate").textContent = startIso ? formatLocal(startIso) : "";

        if (details?.primaryVenue?.mapUrl) {
          $("mapBtn").href = details.primaryVenue.mapUrl;
        }

        // --- 2. Calendar Links ---
        // Safety: Ensure calendarUrl is defined in scope, else ignore
        if (typeof calendarUrl !== 'undefined') {
          try {
            const httpsIcs = new URL(calendarUrl, window.location.href).toString();
            $("subscribeBtn").href = httpsIcs.replace(/^https:/, "webcal:");
          } catch (e) { console.warn("Calendar URL error", e); }
        }

        if (startIso) {
          renderCountdown($("countdown"), startIso, details?.primaryEvent?.title || "");
        }

        // --- 3. Render Schedule (Timeline Style) ---
        const schedule = $("schedule");
        
        // Safety check: ensure the DOM element actually exists before trying to modify it
        if (schedule && schedule.style) { 
          schedule.innerHTML = '<div class="relative ml-3 space-y-0 border-l border-neutral-200 dark:border-neutral-800" id="timelineContainer"></div>';
          
          // Use getElementById directly to ensure we aren't running querySelector on a dummy object
          const timeline = document.getElementById("timelineContainer");

          if (timeline) {
            for (const ev of details.schedule || []) {
              const item = document.createElement("div");
              item.className = "relative pb-8 pl-8 last:pb-0";

              const endTime = ev?.end
                ? new Date(ev.end).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
                : "";

              const startObj = ev?.start ? new Date(ev.start) : null;
              const timeStr = startObj
                ? startObj.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
                : "";
              const dateStr = startObj
                ? startObj.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' })
                : "";

              item.innerHTML = `
                <div class="absolute -left-[5px] top-1 h-2.5 w-2.5 rounded-full bg-neutral-300 ring-4 ring-white dark:bg-neutral-600 dark:ring-neutral-900"></div>
                
                <div class="flex flex-col sm:flex-row sm:items-baseline sm:justify-between gap-1">
                  <h3 class="font-heading text-xl font-medium text-neutral-900 dark:text-white">${ev.title || "Event"}</h3>
                  <span class="text-xs font-semibold uppercase tracking-wider text-neutral-500 dark:text-neutral-400">
                    ${dateStr} <span class="mx-1 opacity-50">|</span> ${timeStr} ${endTime ? `- ${endTime}` : ""}
                  </span>
                </div>

                <div class="mt-1 text-sm text-neutral-600 dark:text-neutral-400">
                  ${[ev.locationName, ev.address].filter(Boolean).join(", ")}
                </div>
                
                ${ev.notes ? `<div class="mt-2 text-sm italic text-neutral-500 dark:text-neutral-500">${ev.notes}</div>` : ""}

                <div class="mt-3 flex gap-3 text-xs font-medium">
                   ${(ev.mapUrl || details?.primaryVenue?.mapUrl) ? `
                    <a class="flex items-center gap-1 hover:text-black dark:hover:text-white transition-colors text-neutral-500" 
                       href="${ev.mapUrl || details?.primaryVenue?.mapUrl}" target="_blank" rel="noopener">
                       <span>üìç</span> Map
                    </a>` : ""}
                   <a class="flex items-center gap-1 hover:text-black dark:hover:text-white transition-colors text-neutral-500" 
                      href="${buildGoogleCalendarLink(ev)}" target="_blank" rel="noopener">
                      <span>üìÖ</span> Add to Cal
                   </a>
                </div>
              `;
              timeline.appendChild(item);
            }
          }
        }

        // --- 4. Render Updates ---
        const updates = $("updates");
        if (updates && updates.style) {
          updates.innerHTML = "";
          for (const u of details.updates || []) {
            const el = document.createElement("div");
            el.className = "rounded-xl bg-neutral-50 p-4 text-sm dark:bg-white/5 border border-transparent dark:border-neutral-800";
            el.innerHTML = `
              <div class="mb-1 text-xs font-bold uppercase tracking-wide text-neutral-400">${u.when ? formatLocal(u.when) : "Update"}</div>
              <div class="text-neutral-700 dark:text-neutral-300">${u.text || ""}</div>
            `;
            updates.appendChild(el);
          }
        }

        // --- 5. Render Contacts (CRASH FIX APPLIED) ---
        const contacts = $("contacts");
        if (contacts && contacts.style) {
          contacts.innerHTML = "";
          contacts.className = "mt-4 grid gap-3 sm:grid-cols-2";

          for (const c of details.contacts || []) {
            const el = document.createElement("div");
            el.className = "flex items-center gap-3 rounded-xl border p-3 dark:border-neutral-800";

            // FIX: Force convert to string to prevent ".replace is not a function" error
            const phoneRaw = String(c.phone || ""); 
            const isPhone = phoneRaw.length > 3; // Basic check
            const link = isPhone ? `tel:${phoneRaw.replace(/[^\d+]/g, '')}` : "#";

            el.innerHTML = `
              <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-neutral-100 dark:bg-neutral-800 text-lg">
                ${c.icon || "üìû"}
              </div>
              <div class="flex-1 min-w-0">
                <div class="truncate font-medium text-neutral-900 dark:text-white">${c.name || "Contact"}</div>
                <div class="truncate text-xs text-neutral-500">${c.role || "Family"}</div>
              </div>
              ${isPhone ? `
                <a href="${link}" class="rounded-full bg-neutral-900 px-3 py-1.5 text-xs font-medium text-white transition-transform hover:scale-105 dark:bg-white dark:text-black">
                  Call
                </a>
              ` : ""}
            `;
            contacts.appendChild(el);
          }
        }

        applyTheme(details.theme);
        applyDecor(details);
        renderCouplePhoto(details);
        renderRsvp(details.rsvp);

      } catch (err) {
        console.error("CRITICAL RENDER ERROR:", err);
        // Optional: alert user or show error on screen
        // alert("Error loading invitation details. Please check console.");
      }
    }

    async function boot() {
      const lockScreen = $("lockScreen");
      const content = $("protectedContent");
      const input = $("passwordInput");
      const btn = $("unlockBtn");
      const error = $("errorMsg");
      const missing = $("missingMsg");
      const lockHint = $("lockHint");

      input?.addEventListener("input", () => error?.classList.add("hidden"));

      let DETAILS = null;

      async function loadDetails() {
        const res = await fetch(detailsUrl, { cache: "no-store" });
        if (!res.ok) throw new Error("DETAILS_NOT_FOUND");
        DETAILS = await res.json();
      }

      const storageKey = `weddings-${slug}-unlocked`;

      function showContent() {
        lockScreen?.classList.add("hidden");
        content?.classList.remove("hidden");
      }

      function showLock() {
        lockScreen?.classList.remove("hidden");
        content?.classList.add("hidden");
      }

      function checkPassword(pw) {
        return DETAILS && String(pw) === String(DETAILS.password);
      }

      function attemptUnlock() {
        if (!input || !error) return;
        if (checkPassword(input.value || "")) {
          localStorage.setItem(storageKey, "true");
          showContent();
          renderInvite(DETAILS);
        } else {
          error.classList.remove("hidden");
        }
      }

      try {
        await loadDetails();

        if (DETAILS?.passwordHint && lockHint) lockHint.textContent = DETAILS.passwordHint;

        // Auto-unlock
        if (localStorage.getItem(storageKey) === "true") {
          showContent();
          renderInvite(DETAILS);
          return;
        }

        btn?.addEventListener("click", attemptUnlock);
        input?.addEventListener("keydown", (e) => {
          if (e.key === "Enter") attemptUnlock();
        });

        showLock();
      } catch (e) {
        showLock();
        missing?.classList.remove("hidden");
      }
    }

    boot();
  </script>
</WeddingLayout>
