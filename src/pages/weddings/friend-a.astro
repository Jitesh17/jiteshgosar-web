---
import BaseLayout from "../../layouts/BaseLayout.astro";

const detailsUrl = "/weddings/friend-a/details.json";
const calendarUrl = "/weddings/friend-a/calendar.ics";
---

<BaseLayout title="Wedding Invitation" description="Wedding invitation details.">
  <div class="mx-auto max-w-3xl px-4 py-10">
    <div class="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm dark:border-neutral-800 dark:bg-neutral-900/30">

      <div class="text-xs font-mono tracking-widest text-neutral-500 dark:text-neutral-400">
        WEDDING INVITATION
      </div>

      <h1 id="coupleNames" class="mt-3 text-4xl font-bold tracking-tight text-neutral-900 dark:text-white">
        Loading…
      </h1>

      <p id="tagline" class="mt-3 text-neutral-600 dark:text-neutral-400"></p>

      <div class="mt-6 flex flex-wrap gap-3 text-sm">
        <div class="rounded-xl border px-3 py-2 dark:border-neutral-800">
          <span class="font-semibold">Date:</span>
          <span id="weddingDate"></span>
        </div>

        <div class="rounded-xl border px-3 py-2 dark:border-neutral-800">
          <span class="font-semibold">Countdown:</span>
          <span id="countdown"></span>
        </div>

        <div class="rounded-xl border px-3 py-2 dark:border-neutral-800">
          <span class="font-semibold">Updated:</span>
          <span id="lastUpdated"></span>
        </div>
      </div>

      <div class="mt-6 flex flex-wrap gap-3">
        <a id="mapBtn" class="rounded-xl border px-4 py-2 text-sm dark:border-neutral-800" target="_blank" rel="noopener">
          Open Google Maps
        </a>

        <a id="subscribeBtn" class="rounded-xl border px-4 py-2 text-sm dark:border-neutral-800">
          Subscribe for calendar updates
        </a>

        <a href={calendarUrl} class="rounded-xl border px-4 py-2 text-sm dark:border-neutral-800" target="_blank" rel="noopener">
          View calendar feed
        </a>
      </div>

      <div class="mt-8 border-t pt-6 dark:border-neutral-800">
        <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">Schedule</h2>
        <div id="schedule" class="mt-4 grid gap-3"></div>
      </div>

      <div class="mt-8 border-t pt-6 dark:border-neutral-800">
        <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">Updates</h2>
        <div id="updates" class="mt-4 grid gap-3"></div>
      </div>

      <div class="mt-8 border-t pt-6 dark:border-neutral-800">
        <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">Contacts</h2>
        <div id="contacts" class="mt-4 grid gap-2 text-sm text-neutral-600 dark:text-neutral-400"></div>
      </div>

    </div>
  </div>

  <script define:vars={{ detailsUrl, calendarUrl }}>
    function pad2(n) { return String(n).padStart(2, "0"); }

    function formatLocal(iso) {
      const d = new Date(iso);
      const opts = { weekday: "short", year: "numeric", month: "short", day: "2-digit", hour: "2-digit", minute: "2-digit" };
      return d.toLocaleString(undefined, opts);
    }

    function renderCountdown(el, targetIso, label) {
      function tick() {
        const ms = new Date(targetIso).getTime() - Date.now();
        if (ms <= 0) {
          el.textContent = `${label}: happening now`;
          return;
        }
        const s = Math.floor(ms / 1000);
        const days = Math.floor(s / 86400);
        const hours = Math.floor((s % 86400) / 3600);
        const mins = Math.floor((s % 3600) / 60);
        const secs = s % 60;
        el.textContent = `${days}d ${pad2(hours)}h ${pad2(mins)}m ${pad2(secs)}s`;
      }
      tick();
      setInterval(tick, 1000);
    }

    function buildGoogleCalendarLink(ev) {
      const start = new Date(ev.start);
      const end = new Date(ev.end);

      const fmt = (d) => {
        const y = d.getUTCFullYear();
        const mo = pad2(d.getUTCMonth() + 1);
        const da = pad2(d.getUTCDate());
        const h = pad2(d.getUTCHours());
        const mi = pad2(d.getUTCMinutes());
        const ss = pad2(d.getUTCSeconds());
        return `${y}${mo}${da}T${h}${mi}${ss}Z`;
      };

      const dates = `${fmt(start)}/${fmt(end)}`;
      const text = encodeURIComponent(ev.title);
      const details = encodeURIComponent(ev.notes || "");
      const location = encodeURIComponent([ev.locationName, ev.address].filter(Boolean).join(", "));
      return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&details=${details}&location=${location}`;
    }

    const $ = (id) => document.getElementById(id);

    async function main() {
      const res = await fetch(detailsUrl, { cache: "no-store" });
      const data = await res.json();

      $("coupleNames").textContent = data.coupleNames;
      $("tagline").textContent = data.tagline;
      $("weddingDate").textContent = formatLocal(data.primaryEvent.start);
      $("lastUpdated").textContent = formatLocal(data.lastUpdated);

      $("mapBtn").href = data.primaryVenue.mapUrl;

      const httpsIcs = new URL(calendarUrl, window.location.href).toString();
      $("subscribeBtn").href = httpsIcs.replace(/^https:/, "webcal:");

      renderCountdown($("countdown"), data.primaryEvent.start, data.primaryEvent.title);

      const schedule = $("schedule");
      schedule.innerHTML = "";
      for (const ev of data.schedule) {
        const el = document.createElement("div");
        el.className = "rounded-2xl border p-4 dark:border-neutral-800";

        el.innerHTML = `
          <div class="flex flex-wrap justify-between gap-2">
            <div class="font-semibold">${ev.title}</div>
            <div class="text-sm text-amber-600 dark:text-amber-400">
              ${formatLocal(ev.start)} to ${new Date(ev.end).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}
            </div>
          </div>
          <div class="mt-2 text-sm text-neutral-500">
            ${[ev.locationName, ev.address].filter(Boolean).join(", ")}
          </div>
          ${ev.notes ? `<div class="mt-2 text-sm text-neutral-500">${ev.notes}</div>` : ""}
          <div class="mt-3 flex gap-2 text-sm">
            <a class="rounded-xl border px-3 py-1 dark:border-neutral-800" href="${ev.mapUrl}" target="_blank">Maps</a>
            <a class="rounded-xl border px-3 py-1 dark:border-neutral-800" href="${buildGoogleCalendarLink(ev)}" target="_blank">
              Add to Google Calendar
            </a>
          </div>
        `;
        schedule.appendChild(el);
      }

      const updates = $("updates");
      updates.innerHTML = "";
      for (const u of data.updates) {
        const el = document.createElement("div");
        el.className = "rounded-2xl border p-4 text-sm dark:border-neutral-800";
        el.innerHTML = `
          <div class="text-xs text-neutral-500">${formatLocal(u.when)}</div>
          <div class="mt-1">${u.text}</div>
        `;
        updates.appendChild(el);
      }

      const contacts = $("contacts");
      contacts.innerHTML = "";
      for (const c of data.contacts) {
        const el = document.createElement("div");
        el.innerHTML = `<strong>${c.name}</strong> (${c.role}) · ${c.phone}`;
        contacts.appendChild(el);
      }
    }

    main().catch(console.error);
  </script>
</BaseLayout>
