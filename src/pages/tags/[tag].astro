---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = (await getCollection("blog")).filter((p) => !p.data.draft);
  const tags = new Set<string>();

  for (const p of posts) {
    for (const t of p.data.tags ?? []) tags.add(String(t));
  }

  return Array.from(tags).map((tag) => ({
    params: { tag: encodeURIComponent(tag) },
    props: { tag },
  }));
}

const { tag } = Astro.props;

// Filter posts by tag
const posts = (await getCollection("blog"))
  .filter((p) => !p.data.draft)
  .filter((p) => (p.data.tags ?? []).map(String).includes(tag))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

function fmtDate(d: Date) {
  return d.toISOString().slice(0, 10);
}
---

<BaseLayout title={`Tag: ${tag}`} description={`Posts tagged "${tag}".`}>
  <div class="mx-auto max-w-3xl px-4 py-16">
    
    <header class="mb-12 flex items-center justify-between border-b border-neutral-800 pb-8">
      <div>
        <h1 class="text-3xl font-bold tracking-tight text-white">#{tag}</h1>
        <p class="mt-2 text-base text-neutral-400">
          {posts.length} article{posts.length === 1 ? "" : "s"}
        </p>
      </div>
      
      <a
        href="/blog/"
        class="group flex items-center text-sm font-medium text-neutral-400 transition hover:text-neutral-200"
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="mr-1 h-4 w-4 transition-transform group-hover:-translate-x-1">
          <path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd" />
        </svg>
        Back to all
      </a>
    </header>

    <ul class="space-y-6">
      {posts.map((post) => (
        <li>
          <a
            href={`/blog/${post.slug}/`}
            class="group relative flex flex-col gap-3 rounded-xl border border-neutral-800/50 bg-neutral-900/20 p-6 transition-all duration-300 hover:border-neutral-700 hover:bg-neutral-900/60"
          >
            <div class="flex items-center justify-between text-xs">
              <time class="font-mono text-neutral-500">{fmtDate(post.data.pubDate)}</time>
            </div>

            <div class="space-y-2">
              <h2 class="text-xl font-semibold text-neutral-100 transition-colors group-hover:text-white">
                {post.data.title}
              </h2>
              <p class="line-clamp-2 text-sm leading-relaxed text-neutral-400">
                {post.data.description}
              </p>
            </div>
            
            <div class="mt-2 flex items-center text-sm font-medium text-neutral-300 opacity-0 -translate-x-2 transition-all duration-300 group-hover:opacity-100 group-hover:translate-x-0">
                <span>Read article</span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="ml-2 h-4 w-4">
                  <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
                </svg>
            </div>
          </a>
        </li>
      ))}
    </ul>
  </div>
</BaseLayout>